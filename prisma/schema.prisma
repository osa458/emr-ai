generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          UserRole  @default(PHYSICIAN)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  preferences   UserPreference?
  aiInteractions AIInteraction[]
}

enum UserRole {
  PHYSICIAN
  NURSE
  CODER
  DISCHARGE_PLANNER
  ADMIN
}

// User preferences and settings
model UserPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id])

  // Dashboard preferences
  defaultTriageView     String   @default("all")
  defaultDischargeView  String   @default("ready_first")

  // AI preferences
  aiAssistEnabled       Boolean  @default(true)
  showBillingSuggestions Boolean @default(true)

  // UI preferences
  sidebarCollapsed      Boolean  @default(false)
  theme                 String   @default("system")

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Log AI interactions for analytics (no PHI stored)
model AIInteraction {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  interactionType String   // diagnostic_assist, billing_assist, triage, discharge
  // Store only metadata, not PHI
  inputTokens     Int?
  outputTokens    Int?
  latencyMs       Int?
  wasAccepted     Boolean?

  createdAt       DateTime @default(now())
}

// Feature flags
model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Patient records
model Patient {
  id          String   @id @default(cuid())
  mrn         String   @unique
  firstName   String
  lastName    String
  birthDate   DateTime
  gender      String
  phone       String?
  email       String?
  address     String?
  status      PatientStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointments Appointment[]
  encounters   Encounter[]
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  DECEASED
}

// Practitioner/Provider records
model Practitioner {
  id            String   @id @default(cuid())
  npi           String?  @unique
  firstName     String
  lastName      String
  specialty     String?
  phone         String?
  email         String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  appointments  Appointment[]
  encounters    Encounter[]
}

// Appointments
model Appointment {
  id              String   @id @default(cuid())
  patientId       String
  patient         Patient  @relation(fields: [patientId], references: [id])
  practitionerId  String?
  practitioner    Practitioner? @relation(fields: [practitionerId], references: [id])
  serviceType     String
  status          AppointmentStatus @default(BOOKED)
  start           DateTime
  end             DateTime
  minutesDuration Int      @default(30)
  reason          String?
  mode            AppointmentMode @default(IN_PERSON)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum AppointmentStatus {
  PROPOSED
  PENDING
  BOOKED
  ARRIVED
  FULFILLED
  CANCELLED
  NOSHOW
}

enum AppointmentMode {
  IN_PERSON
  TELEHEALTH
  PHONE
}

// Encounters/Visits
model Encounter {
  id              String   @id @default(cuid())
  patientId       String
  patient         Patient  @relation(fields: [patientId], references: [id])
  practitionerId  String?
  practitioner    Practitioner? @relation(fields: [practitionerId], references: [id])
  type            String
  status          EncounterStatus @default(IN_PROGRESS)
  class           String?  // inpatient, outpatient, emergency
  reasonCode      String?
  startDate       DateTime @default(now())
  endDate         DateTime?
  location        String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum EncounterStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  DISCHARGED
  CANCELLED
}

// Services/Procedures catalog
model Service {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  category    String?
  price       Decimal? @db.Decimal(10, 2)
  duration    Int?     // minutes
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoiceItems InvoiceItem[]
}

// Invoices
model Invoice {
  id          String   @id @default(cuid())
  invoiceNo   String   @unique
  patientId   String
  status      InvoiceStatus @default(DRAFT)
  issueDate   DateTime @default(now())
  dueDate     DateTime?
  subtotal    Decimal  @db.Decimal(10, 2)
  tax         Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  paidAmount  Decimal  @default(0) @db.Decimal(10, 2)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       InvoiceItem[]
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  serviceId   String?
  service     Service? @relation(fields: [serviceId], references: [id])
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
}

// Audit log for compliance
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}
